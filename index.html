<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å€‹äººè¨˜å¸³æœ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      min-height: 100vh;
      background:
        radial-gradient(circle at 0% 0%, rgba(99, 179, 237, 0.18), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(125, 211, 252, 0.2), transparent 60%),
        linear-gradient(135deg, #f4f7ff, #e6f7ff);
      display: flex;
      justify-content: center;
    }
    .app-shell {
      width: 100%;
      max-width: 960px;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.92);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(148, 163, 184, 0.14);
      backdrop-filter: blur(12px);
      padding: 16px 18px 18px;
    }
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 4px 10px;
      border-bottom: 1px dashed #d4dbe8;
      margin-bottom: 8px;
    }
    .app-title-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: conic-gradient(from 210deg, #4f46e5, #22c55e, #0ea5e9, #4f46e5);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }
    .app-title-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .app-title-text h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      color: #0f172a;
    }
    .subtitle {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .app-badge {
      font-size: 0.7rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.06);
      color: #2563eb;
      border: 1px solid rgba(129, 140, 248, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .section-card {
      background: #f9fbff;
      border-radius: 18px;
      padding: 10px 12px 12px;
      border: 1px solid #e0e7ff;
      margin-bottom: 10px;
    }
    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }
    .section-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 0.98rem;
      color: #111827;
    }
    .section-title span.icon {
      font-size: 1rem;
    }
    .section-tip {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .field {
      flex: 1;
      min-width: 150px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.84rem;
    }
    label {
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    label .label-tag {
      font-size: 0.7rem;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.1);
      color: #2563eb;
    }

    input[type="datetime-local"],
    input[type="date"],
    input[type="number"],
    input[type="text"],
    select {
      padding: 7px 9px;
      border-radius: 11px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 0.9rem;
      background-color: #f9fafb;
      transition:
        border-color 0.15s,
        box-shadow 0.15s,
        background-color 0.15s,
        transform 0.08s;
    }
    input:focus,
    select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.3);
      background-color: #ffffff;
      transform: translateY(-0.5px);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      transition:
        transform 0.08s,
        box-shadow 0.12s,
        background-color 0.2s,
        opacity 0.1s;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      color: #fff;
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.45);
    }
    .btn-primary:hover {
      opacity: 0.96;
    }
    .btn-secondary {
      background: #eef2ff;
      color: #1f2933;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.25);
    }
    .btn-secondary:hover {
      background: #e0e7ff;
    }
    .btn-danger {
      background: #f97373;
      background: linear-gradient(135deg, #f97373, #ef4444);
      color: #fff;
      box-shadow: 0 5px 14px rgba(239, 68, 68, 0.5);
    }
    .btn-danger:hover {
      opacity: 0.95;
    }
    .btn-ghost {
      background: transparent;
      color: #6b7280;
      padding-inline: 8px;
      box-shadow: none;
    }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    hr {
      border: none;
      border-top: 1px dashed #d2d8e5;
      margin: 10px 0;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .summary-chip {
      flex: 1;
      min-width: 140px;
      padding: 8px 10px;
      border-radius: 14px;
      background: #fefefe;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.82rem;
    }
    .summary-label {
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.78rem;
    }
    .summary-value {
      font-weight: 600;
      font-size: 1rem;
    }
    .summary-income {
      color: #059669;
    }
    .summary-expense {
      color: #dc2626;
    }
    .summary-balance {
      color: #1d4ed8;
    }

    /* æ™‚é–“ç¯„åœå°æŒ‰éˆ• */
    .range-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .btn-chip {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f4ff;
      color: #4b5563;
      font-size: 0.78rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 2px 6px rgba(148, 163, 184, 0.25);
    }
    .btn-chip:hover {
      background: #e5e7ff;
    }
    .btn-chip-active {
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      color: #fff;
      border-color: rgba(79, 70, 229, 0.9);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
    }

    .hint-text {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }

    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }
    .records-header-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .records-header-title-main {
      font-weight: 600;
      font-size: 0.95rem;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .records-header-sub {
      font-size: 0.74rem;
      color: #6b7280;
    }

    .table-wrapper {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #ffffff;
      max-height: 360px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    thead {
      background: linear-gradient(135deg, #eef2ff, #e0f2fe);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 6px 6px;
      text-align: center;
      border-bottom: 1px solid #edf0fa;
    }
    th {
      font-weight: 600;
      color: #4b5563;
    }
    tbody tr:nth-child(odd) {
      background: #f9fafb;
    }
    tbody tr:nth-child(even) {
      background: #ffffff;
    }
    tbody tr:hover {
      background: #e5f0ff;
    }
    .note-cell {
      text-align: left;
    }
    .type-income {
      color: #059669;
      font-weight: 600;
    }
    .type-expense {
      color: #dc2626;
      font-weight: 600;
    }
    .no-data {
      text-align: center;
      padding: 8px;
      color: #6b7280;
      font-size: 0.8rem;
    }
    .small-text {
      font-size: 0.74rem;
      color: #6b7280;
    }
    .footer-note {
      text-align: right;
      margin-top: 6px;
      color: #9ca3af;
      font-size: 0.7rem;
    }

    @media (max-width: 640px) {
      .app-shell {
        padding: 14px 10px 16px;
        border-radius: 20px;
      }
      .app-title-wrap {
        gap: 8px;
      }
      .logo-circle {
        width: 34px;
        height: 34px;
      }
      .app-title-text h1 {
        font-size: 1.2rem;
      }
      table {
        font-size: 0.78rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-title-wrap">
        <div class="logo-circle">
          <div class="logo-inner">ğŸ’°</div>
        </div>
        <div class="app-title-text">
          <h1>å€‹äººè¨˜å¸³æœ¬</h1>
          <div class="subtitle">è¨˜ä¸‹æ¯ä¸€ç­†æ”¶å…¥èˆ‡æ”¯å‡ºï¼Œè®“éŒ¢éŒ¢çŸ¥é“è‡ªå·±è¦å»å“ª ğŸ’¸</div>
        </div>
      </div>
      <div class="app-badge">
        <span>ğŸ“…</span> ä»Šæ—¥é‡é»ï¼šæŒæ¡ç¾é‡‘æµ
      </div>
    </header>

    <!-- æ–°å¢ç´€éŒ„ -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          <span class="icon">ğŸ“</span>
          <span>æ–°å¢ç´€éŒ„</span>
        </div>
        <button class="btn-ghost" type="button" id="quickTodayBtn">â± ä¸€éµå¡«å…¥ã€Œç¾åœ¨ã€æ—¥æœŸ</button>
      </div>

      <div class="flex-row">
        <div class="field">
          <label for="datetimeInput">
            æ—¥æœŸæ™‚é–“
            <span class="label-tag">å¿…å¡«</span>
          </label>
          <input type="datetime-local" id="datetimeInput">
          <button class="btn-secondary" id="nowBtn" style="margin-top:3px;">
            â° ä½¿ç”¨ç¾åœ¨æ™‚é–“
          </button>
        </div>

        <div class="field">
          <label for="typeInput">
            é¡å‹
            <span class="label-tag">æ”¶å…¥ / æ”¯å‡º</span>
          </label>
          <select id="typeInput">
            <option value="expense">æ”¯å‡º</option>
            <option value="income">æ”¶å…¥</option>
          </select>
        </div>

        <div class="field">
          <label for="categorySelect">
            åˆ†é¡å¸³æœ¬
            <span class="label-tag">å¯è‡ªè¨‚</span>
          </label>
          <div class="flex-row" style="gap:6px; margin-bottom:0;">
            <select id="categorySelect" style="flex:1;"></select>
            <button type="button" class="btn-secondary" id="addCategoryBtn" style="padding:6px 10px; font-size:0.8rem;">
              ï¼‹
            </button>
          </div>
          <div class="small-text">æŒ‰ã€Œï¼‹ã€å¯æ–°å¢è‡ªè¨‚åˆ†é¡å¸³æœ¬</div>
        </div>
      </div>

      <div class="flex-row">
        <div class="field">
          <label for="amountInput">
            é‡‘é¡ï¼ˆæ­£æ•¸ï¼‰
            <span class="label-tag">å¿…å¡«</span>
          </label>
          <input type="number" id="amountInput" min="0" step="1" placeholder="ä¾‹å¦‚ 120">
        </div>
        <div class="field" style="flex:2;">
          <label for="noteInput">å‚™è¨»</label>
          <input type="text" id="noteInput" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€Uberã€è–ªæ°´ã€çé‡‘â€¦">
        </div>
      </div>

      <div class="btn-group">
        <button class="btn-primary" id="addRecordBtn">
          â• æ–°å¢ç´€éŒ„
        </button>
      </div>
    </section>

    <!-- å…¨éƒ¨ç¸½è¨ˆ -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          <span class="icon">ğŸ“Š</span>
          <span>å…¨éƒ¨ç´€éŒ„ç¸½è¨ˆ</span>
        </div>
      </div>
      <div class="summary-row">
        <div class="summary-chip">
          <div class="summary-label">
            <span>â¬†ï¸ ç¸½æ”¶å…¥</span>
          </div>
          <div class="summary-value summary-income" id="totalIncome">0</div>
        </div>
        <div class="summary-chip">
          <div class="summary-label">
            <span>â¬‡ï¸ ç¸½æ”¯å‡º</span>
          </div>
          <div class="summary-value summary-expense" id="totalExpense">0</div>
        </div>
        <div class="summary-chip">
          <div class="summary-label">
            <span>ğŸ’¼ ç¸½çµé¤˜ï¼ˆæ”¶å…¥ï¼æ”¯å‡ºï¼‰</span>
          </div>
          <div class="summary-value summary-balance" id="totalBalance">0</div>
        </div>
      </div>
    </section>

    <!-- å€é–“ & åˆ†é¡ç¸½è¨ˆ -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          <span class="icon">ğŸ“†</span>
          <span>å€é–“ & åˆ†é¡ç¸½è¨ˆ</span>
        </div>
      </div>

      <div class="flex-row">
        <div class="field" style="flex-basis:100%;">
          <label>æ™‚é–“ç¯„åœ</label>
          <div class="range-buttons">
            <button type="button" class="btn-chip" data-range="all">å…¨éƒ¨</button>
            <button type="button" class="btn-chip" data-range="year">ä»Šå¹´</button>
            <button type="button" class="btn-chip" data-range="month">æœ¬æœˆ</button>
            <button type="button" class="btn-chip" data-range="day">ä»Šå¤©</button>
            <button type="button" class="btn-chip" data-range="custom">è‡ªè¨‚</button>
          </div>
        </div>
        <div class="field" id="customRangeGroup" style="display:none;">
          <label>è‡ªè¨‚æ—¥æœŸå€é–“</label>
          <div class="flex-row" style="gap:4px; margin-bottom:0;">
            <input type="date" id="rangeStart">
            <span style="align-self:center; font-size:0.8rem;">ï½</span>
            <input type="date" id="rangeEnd">
          </div>
        </div>
        <div class="field" style="align-self:flex-end; min-width:auto;">
          <button class="btn-secondary" id="applyRangeBtn">ğŸ” å¥—ç”¨ç¯©é¸</button>
        </div>
      </div>
      <div class="hint-text">
        é è¨­ç‚ºã€Œä»Šå¤©ã€ã€‚å¯åˆ‡æ›ä»Šå¹´ã€æœ¬æœˆã€å…¨éƒ¨æˆ–è‡ªè¨‚æ—¥æœŸï¼Œä¸‹æ–¹æœƒé¡¯ç¤ºè©²æœŸé–“å„åˆ†é¡çš„æ”¶å…¥ã€æ”¯å‡ºèˆ‡çµé¤˜ã€‚
      </div>

      <div class="summary-row" style="margin-top:8px;">
        <div class="summary-chip">
          <div class="summary-label">æ­¤å€é–“æ”¶å…¥</div>
          <div class="summary-value summary-income" id="rangeIncome">0</div>
        </div>
        <div class="summary-chip">
          <div class="summary-label">æ­¤å€é–“æ”¯å‡º</div>
          <div class="summary-value summary-expense" id="rangeExpense">0</div>
        </div>
        <div class="summary-chip">
          <div class="summary-label">æ­¤å€é–“çµé¤˜</div>
          <div class="summary-value summary-balance" id="rangeBalance">0</div>
        </div>
      </div>

      <div class="table-wrapper" style="margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>åˆ†é¡å¸³æœ¬</th>
              <th>æ”¶å…¥</th>
              <th>æ”¯å‡º</th>
              <th>çµé¤˜</th>
            </tr>
          </thead>
          <tbody id="categorySummaryTbody">
            <!-- å‹•æ…‹å¡«å…¥ -->
          </tbody>
        </table>
      </div>
      <div id="categorySummaryHint" class="no-data" style="display:none;">
        æ­¤å€é–“å…§ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚
      </div>
    </section>

    <!-- ç´€éŒ„åˆ—è¡¨ -->
    <section class="section-card">
      <div class="records-header">
        <div class="records-header-title">
          <div class="records-header-title-main">
            <span>ğŸ“š ç´€éŒ„åˆ—è¡¨ï¼ˆä¾æ™‚é–“ç¯„åœï¼‰</span>
          </div>
          <div class="records-header-sub">
            æœƒè·Ÿä¸Šæ–¹æ™‚é–“ç¯„åœåŒæ­¥åˆ‡æ›é¡¯ç¤º
          </div>
        </div>
        <button class="btn-danger" id="clearAllBtn">ğŸ§¹ æ¸…ç©ºå…¨éƒ¨ç´€éŒ„</button>
      </div>

      <!-- åˆ—è¡¨æ™‚é–“ç¯„åœæŒ‰éˆ•ï¼ˆèˆ‡ä¸Šé¢å…±ç”¨ï¼‰ -->
      <div class="flex-row">
        <div class="field" style="flex-basis:100%;">
          <label>åˆ—è¡¨æ™‚é–“ç¯„åœ</label>
          <div class="range-buttons">
            <button type="button" class="btn-chip" data-range="all">å…¨éƒ¨</button>
            <button type="button" class="btn-chip" data-range="year">ä»Šå¹´</button>
            <button type="button" class="btn-chip" data-range="month">æœ¬æœˆ</button>
            <button type="button" class="btn-chip" data-range="day">ä»Šå¤©</button>
            <button type="button" class="btn-chip" data-range="custom">è‡ªè¨‚</button>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>æ—¥æœŸæ™‚é–“</th>
              <th>é¡å‹</th>
              <th>åˆ†é¡å¸³æœ¬</th>
              <th>é‡‘é¡</th>
              <th>å‚™è¨»</th>
              <th>åˆªé™¤</th>
            </tr>
          </thead>
          <tbody id="recordsTbody">
            <!-- å‹•æ…‹å¡«å…¥ -->
          </tbody>
        </table>
      </div>
      <div id="noDataHint" class="no-data" style="display:none;">
        ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ï¼Œå¯ä»¥å…ˆå¾ä¸Šé¢æ–°å¢ä¸€ç­† âœï¸
      </div>
    </section>

    <div class="footer-note">
      è³‡æ–™åƒ…å„²å­˜åœ¨æ­¤è£ç½®çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚
    </div>
  </div>

  <script>
    // === LocalStorage Keys ===
    const STORAGE_KEY_RECORDS = "ledger_records_v1";
    const STORAGE_KEY_CATEGORIES = "ledger_categories_v1";

    // === Elements ===
    const datetimeInput = document.getElementById("datetimeInput");
    const nowBtn = document.getElementById("nowBtn");
    const quickTodayBtn = document.getElementById("quickTodayBtn");
    const typeInput = document.getElementById("typeInput");
    const categorySelect = document.getElementById("categorySelect");
    const addCategoryBtn = document.getElementById("addCategoryBtn");
    const amountInput = document.getElementById("amountInput");
    const noteInput = document.getElementById("noteInput");
    const addRecordBtn = document.getElementById("addRecordBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const recordsTbody = document.getElementById("recordsTbody");
    const noDataHint = document.getElementById("noDataHint");

    // å…¨éƒ¨ç´€éŒ„ç¸½è¨ˆæ¬„ä½
    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpenseEl = document.getElementById("totalExpense");
    const totalBalanceEl = document.getElementById("totalBalance");

    // å€é–“ç¯©é¸ç›¸é—œ
    const customRangeGroup = document.getElementById("customRangeGroup");
    const rangeStartInput = document.getElementById("rangeStart");
    const rangeEndInput = document.getElementById("rangeEnd");
    const applyRangeBtn = document.getElementById("applyRangeBtn");
    const rangeButtons = document.querySelectorAll(".btn-chip");

    const rangeIncomeEl = document.getElementById("rangeIncome");
    const rangeExpenseEl = document.getElementById("rangeExpense");
    const rangeBalanceEl = document.getElementById("rangeBalance");
    const categorySummaryTbody = document.getElementById("categorySummaryTbody");
    const categorySummaryHint = document.getElementById("categorySummaryHint");

    // === State ===
    let records = [];
    let categories = [];
    let currentRangeType = "day"; // é è¨­ç‚ºä»Šå¤©

    // å–å¾—ç¾åœ¨æ™‚é–“ä¸¦æ ¼å¼åŒ–æˆ datetime-local
    function getNowForInput() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const day = String(now.getDate()).padStart(2, "0");
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function setNowToInput() {
      datetimeInput.value = getNowForInput();
    }

    // è®€å– LocalStorage
    function loadFromStorage() {
      const recStr = localStorage.getItem(STORAGE_KEY_RECORDS);
      const catStr = localStorage.getItem(STORAGE_KEY_CATEGORIES);

      records = recStr ? JSON.parse(recStr) : [];
      categories = catStr ? JSON.parse(catStr) : [];
      if (!Array.isArray(categories) || categories.length === 0) {
        categories = ["ä¸€èˆ¬", "é£²é£Ÿ", "äº¤é€š", "ç”Ÿæ´»", "å¨›æ¨‚", "æŠ•è³‡", "é†«ç™‚", "å…¶ä»–"];
      }
    }

    // å„²å­˜åˆ° LocalStorage
    function saveRecords() {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
    }
    function saveCategories() {
      localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(categories));
    }

    // æ›´æ–°åˆ†é¡ä¸‹æ‹‰é¸å–®
    function renderCategoryOptions() {
      categorySelect.innerHTML = "";
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    // è¨ˆç®—ä¸¦æ›´æ–°ã€Œå…¨éƒ¨ç´€éŒ„ã€ç¸½è¨ˆ
    function updateTotals() {
      let income = 0;
      let expense = 0;
      records.forEach(r => {
        if (r.type === "income") {
          income += r.amount;
        } else if (r.type === "expense") {
          expense += r.amount;
        }
      });
      const balance = income - expense;

      totalIncomeEl.textContent = income.toLocaleString();
      totalExpenseEl.textContent = expense.toLocaleString();
      totalBalanceEl.textContent = balance.toLocaleString();
    }

    // é¡¯ç¤ºç”¨æ™‚é–“æ ¼å¼
    function formatDatetimeDisplay(dtStr) {
      if (!dtStr) return "";
      const [datePart, timePart] = dtStr.split("T");
      if (!datePart || !timePart) return dtStr;
      const [y, m, d] = datePart.split("-");
      const [hh, mm] = timePart.split(":");
      return `${y}/${m}/${d} ${hh}:${mm}`;
    }

    // å–å¾—ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹çš„ç´€éŒ„
    function getFilteredRecordsByRange() {
      const type = currentRangeType;
      if (records.length === 0) return [];

      const now = new Date();
      const nowYear = now.getFullYear();
      const nowMonth = now.getMonth(); // 0-11
      const nowDate = now.getDate();

      return records.filter(rec => {
        if (!rec.datetime) return false;
        const recDate = new Date(rec.datetime);

        if (type === "all") {
          return true;
        } else if (type === "year") {
          return recDate.getFullYear() === nowYear;
        } else if (type === "month") {
          return recDate.getFullYear() === nowYear &&
                 recDate.getMonth() === nowMonth;
        } else if (type === "day") {
          return recDate.getFullYear() === nowYear &&
                 recDate.getMonth() === nowMonth &&
                 recDate.getDate() === nowDate;
        } else if (type === "custom") {
          const startStr = rangeStartInput.value;
          const endStr = rangeEndInput.value;
          if (!startStr || !endStr) return false;
          const start = new Date(startStr + "T00:00:00");
          const end = new Date(endStr + "T23:59:59");
          if (isNaN(start.getTime()) || isNaN(end.getTime())) return false;
          return recDate >= start && recDate <= end;
        }
        return true;
      });
    }

    // æ¸²æŸ“ç´€éŒ„è¡¨æ ¼ï¼ˆä¾ç›®å‰æ™‚é–“ç¯„åœï¼‰
    function renderRecords() {
      recordsTbody.innerHTML = "";

      if (records.length === 0) {
        noDataHint.textContent = "ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ï¼Œå¯ä»¥å…ˆå¾ä¸Šé¢æ–°å¢ä¸€ç­† âœï¸";
        noDataHint.style.display = "block";
        updateTotals();
        updateRangeSummary();
        return;
      }

      const list = getFilteredRecordsByRange();
      if (!list || list.length === 0) {
        noDataHint.textContent = "æ­¤æ™‚é–“ç¯„åœå…§æ²’æœ‰ç´€éŒ„ã€‚";
        noDataHint.style.display = "block";
      } else {
        noDataHint.style.display = "none";

        // ä¾æ™‚é–“æ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
        const sorted = [...list].sort((a, b) => {
          if (a.datetime === b.datetime) return 0;
          return a.datetime < b.datetime ? 1 : -1;
        });

        sorted.forEach(rec => {
          const tr = document.createElement("tr");

          const tdTime = document.createElement("td");
          tdTime.textContent = formatDatetimeDisplay(rec.datetime);
          tr.appendChild(tdTime);

          const tdType = document.createElement("td");
          tdType.textContent = rec.type === "income" ? "æ”¶å…¥" : "æ”¯å‡º";
          tdType.className = rec.type === "income" ? "type-income" : "type-expense";
          tr.appendChild(tdType);

          const tdCat = document.createElement("td");
          tdCat.textContent = rec.category || "";
          tr.appendChild(tdCat);

          const tdAmount = document.createElement("td");
          tdAmount.textContent = rec.amount.toLocaleString();
          tr.appendChild(tdAmount);

          const tdNote = document.createElement("td");
          tdNote.textContent = rec.note || "";
          tdNote.className = "note-cell";
          tr.appendChild(tdNote);

          const tdDel = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.textContent = "åˆªé™¤";
          delBtn.className = "btn-danger";
          delBtn.style.padding = "4px 10px";
          delBtn.style.fontSize = "0.75rem";
          delBtn.addEventListener("click", () => {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
              records = records.filter(r => r.id !== rec.id);
              saveRecords();
              renderRecords();
            }
          });
          tdDel.appendChild(delBtn);
          tr.appendChild(tdDel);

          recordsTbody.appendChild(tr);
        });
      }

      updateTotals();
      updateRangeSummary();
    }

    // æ›´æ–°ã€Œå€é–“ & åˆ†é¡ç¸½è¨ˆã€
    function updateRangeSummary() {
      const filtered = getFilteredRecordsByRange();

      if (!filtered || filtered.length === 0) {
        rangeIncomeEl.textContent = "0";
        rangeExpenseEl.textContent = "0";
        rangeBalanceEl.textContent = "0";
        categorySummaryTbody.innerHTML = "";
        categorySummaryHint.style.display = "block";
        return;
      }

      categorySummaryHint.style.display = "none";

      let income = 0;
      let expense = 0;
      const map = {};

      filtered.forEach(rec => {
        const cat = rec.category || "æœªåˆ†é¡";
        if (!map[cat]) {
          map[cat] = { income: 0, expense: 0 };
        }
        if (rec.type === "income") {
          income += rec.amount;
          map[cat].income += rec.amount;
        } else if (rec.type === "expense") {
          expense += rec.amount;
          map[cat].expense += rec.amount;
        }
      });

      const balance = income - expense;
      rangeIncomeEl.textContent = income.toLocaleString();
      rangeExpenseEl.textContent = expense.toLocaleString();
      rangeBalanceEl.textContent = balance.toLocaleString();

      categorySummaryTbody.innerHTML = "";
      const cats = Object.keys(map).sort();
      cats.forEach(cat => {
        const info = map[cat];
        const row = document.createElement("tr");

        const tdCat = document.createElement("td");
        tdCat.textContent = cat;
        row.appendChild(tdCat);

        const tdIn = document.createElement("td");
        tdIn.textContent = info.income.toLocaleString();
        row.appendChild(tdIn);

        const tdOut = document.createElement("td");
        tdOut.textContent = info.expense.toLocaleString();
        row.appendChild(tdOut);

        const tdBal = document.createElement("td");
        tdBal.textContent = (info.income - info.expense).toLocaleString();
        row.appendChild(tdBal);

        categorySummaryTbody.appendChild(row);
      });
    }

    // æ–°å¢åˆ†é¡ï¼ˆç”¨ promptï¼‰
    function handleAddCategory() {
      let name = prompt("è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±ï¼š");
      if (name === null) return; // æŒ‰å–æ¶ˆ
      name = name.trim();
      if (!name) {
        alert("åˆ†é¡åç¨±ä¸èƒ½æ˜¯ç©ºç™½");
        return;
      }
      if (categories.includes(name)) {
        alert("æ­¤åˆ†é¡å·²å­˜åœ¨");
        return;
      }
      categories.push(name);
      saveCategories();
      renderCategoryOptions();
      categorySelect.value = name;
    }

    // æ–°å¢ç´€éŒ„
    function handleAddRecord() {
      const dt = datetimeInput.value;
      const type = typeInput.value;
      const category = categorySelect.value;
      const amountStr = amountInput.value;
      const note = noteInput.value.trim();

      if (!dt) {
        alert("è«‹é¸æ“‡æ—¥æœŸæ™‚é–“");
        return;
      }
      if (!amountStr || Number(amountStr) <= 0) {
        alert("è«‹è¼¸å…¥å¤§æ–¼ 0 çš„é‡‘é¡");
        return;
      }
      const amount = Number(amountStr);

      const record = {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        datetime: dt,
        type,
        category,
        amount,
        note,
        createdAt: new Date().toISOString()
      };

      records.push(record);
      saveRecords();
      renderRecords();

      amountInput.value = "";
      noteInput.value = "";
    }

    // æ¸…ç©ºå…¨éƒ¨ç´€éŒ„
    function handleClearAll() {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
      records = [];
      saveRecords();
      renderRecords();
    }

    // è™•ç†æ™‚é–“ç¯„åœæŒ‰éˆ•é»æ“Šï¼ˆå…©çµ„æŒ‰éˆ•å…±ç”¨ï¼‰
    function handleRangeButtonClick(e) {
      const btn = e.currentTarget;
      const range = btn.getAttribute("data-range");
      currentRangeType = range;

      // åŒä¸€æ™‚é–“ç¯„åœçš„æŒ‰éˆ•å…¨éƒ¨äº®èµ·
      rangeButtons.forEach(b => {
        if (b.getAttribute("data-range") === range) {
          b.classList.add("btn-chip-active");
        } else {
          b.classList.remove("btn-chip-active");
        }
      });

      // è‡ªè¨‚å€é–“é¡¯ç¤ºåˆ‡æ›
      if (range === "custom") {
        customRangeGroup.style.display = "block";
      } else {
        customRangeGroup.style.display = "none";
      }

      renderRecords();
    }

    // å¥—ç”¨ç¯©é¸æŒ‰éˆ•ï¼ˆä¸»è¦çµ¦è‡ªè¨‚å€é–“ç”¨ï¼‰
    function handleApplyRange() {
      if (currentRangeType === "custom") {
        const s = rangeStartInput.value;
        const e = rangeEndInput.value;
        if (!s || !e) {
          alert("è«‹é¸æ“‡è‡ªè¨‚å€é–“çš„èµ·è¨–æ—¥æœŸ");
          return;
        }
      }
      renderRecords();
    }

    // åˆå§‹åŒ–æ™‚é–“ç¯„åœæŒ‰éˆ•ç‹€æ…‹ï¼ˆé è¨­ä»Šå¤©ï¼‰
    function initRangeButtons() {
      rangeButtons.forEach(btn => {
        const range = btn.getAttribute("data-range");
        if (range === currentRangeType) {
          btn.classList.add("btn-chip-active");
        }
        btn.addEventListener("click", handleRangeButtonClick);
      });
      customRangeGroup.style.display = "none"; // é è¨­éè‡ªè¨‚
    }

    function initQuickTodayBtn() {
      if (!quickTodayBtn) return;
      quickTodayBtn.addEventListener("click", setNowToInput);
    }

    // åˆå§‹åŒ–
    function init() {
      loadFromStorage();
      renderCategoryOptions();
      setNowToInput();
      initRangeButtons();
      initQuickTodayBtn();
      renderRecords();

      nowBtn.addEventListener("click", setNowToInput);
      addCategoryBtn.addEventListener("click", handleAddCategory);
      addRecordBtn.addEventListener("click", handleAddRecord);
      clearAllBtn.addEventListener("click", handleClearAll);
      applyRangeBtn.addEventListener("click", handleApplyRange);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
