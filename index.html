<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å€‹äººè¨˜å¸³æœ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: linear-gradient(135deg, #f5f7ff, #e3f6ff);
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border-radius: 16px;
      padding: 18px 14px 22px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.5rem;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 14px;
    }
    .section-title {
      font-weight: 600;
      margin: 8px 0;
      font-size: 1rem;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.85rem;
    }
    label {
      color: #444;
    }
    input[type="datetime-local"],
    input[type="date"],
    input[type="number"],
    input[type="text"],
    select {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #d0d7e2;
      outline: none;
      font-size: 0.9rem;
      background-color: #f8fbff;
      transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s;
    }
    input:focus,
    select:focus {
      border-color: #4a8df6;
      box-shadow: 0 0 0 2px rgba(74, 141, 246, 0.2);
      background-color: #ffffff;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.08s, box-shadow 0.08s, background-color 0.2s;
      white-space: nowrap;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4a8df6, #6bc5ff);
      color: #fff;
      box-shadow: 0 6px 14px rgba(74, 141, 246, 0.4);
    }
    .btn-secondary {
      background: #eef3ff;
      color: #345;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
    }
    .btn-danger {
      background: #ff6b6b;
      color: #fff;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
    }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    hr {
      border: none;
      border-top: 1px dashed #d2d8e5;
      margin: 12px 0;
    }
    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }
    .records-header-title {
      font-weight: 600;
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    thead {
      background: #f5f7ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 6px 4px;
      text-align: center;
      border-bottom: 1px solid #edf0fa;
    }
    th {
      font-weight: 600;
      color: #555;
    }
    tbody tr:nth-child(odd) {
      background: #fafbff;
    }
    tbody tr:hover {
      background: #eef4ff;
    }
    .note-cell {
      text-align: left;
    }
    .type-income {
      color: #0b9b5c;
      font-weight: 600;
    }
    .type-expense {
      color: #e45a5a;
      font-weight: 600;
    }
    .no-data {
      text-align: center;
      padding: 8px;
      color: #777;
    }
    .small-text {
      font-size: 0.75rem;
      color: #777;
    }

    /* ç¸½è¨ˆå¡ç‰‡ï¼ˆå…¨éƒ¨ç´€éŒ„ï¼‰ */
    .summary-card {
      margin-top: 6px;
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(135deg, #e3f6ff, #f5f7ff);
      border: 1px solid #d0e6ff;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }
    .summary-item {
      min-width: 120px;
    }
    .summary-label {
      color: #666;
      margin-bottom: 2px;
    }
    .summary-value {
      font-weight: 600;
      font-size: 1rem;
    }
    .summary-income {
      color: #0b9b5c;
    }
    .summary-expense {
      color: #e45a5a;
    }
    .summary-balance {
      color: #1e3a8a;
    }

    /* å€é–“ç¯©é¸å€ */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .filter-row .field {
      min-width: 110px;
    }
    .hint-text {
      font-size: 0.75rem;
      color: #888;
      margin-top: 2px;
    }

    @media (max-width: 600px) {
      .container {
        padding: 14px 10px 18px;
        border-radius: 18px;
      }
      h1 {
        font-size: 1.35rem;
      }
      .flex-row {
        flex-direction: column;
      }
      table {
        font-size: 0.78rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å€‹äººè¨˜å¸³æœ¬</h1>
    <div class="subtitle">è¨˜ä¸‹æ¯ä¸€ç­†æ”¶å…¥èˆ‡æ”¯å‡ºï¼Œè®“éŒ¢éŒ¢çŸ¥é“è‡ªå·±è¦å»å“ª ğŸ’¸</div>

    <!-- æ–°å¢ç´€éŒ„å€ -->
    <div class="section-title">æ–°å¢ç´€éŒ„</div>
    <section>
      <div class="flex-row">
        <div class="field">
          <label for="datetimeInput">æ—¥æœŸæ™‚é–“</label>
          <input type="datetime-local" id="datetimeInput">
          <button class="btn-secondary" id="nowBtn" style="margin-top:3px;">ä½¿ç”¨ç¾åœ¨æ™‚é–“</button>
        </div>

        <div class="field">
          <label for="typeInput">é¡å‹</label>
          <select id="typeInput">
            <option value="expense">æ”¯å‡º</option>
            <option value="income">æ”¶å…¥</option>
          </select>
        </div>

        <div class="field">
          <label for="categorySelect">åˆ†é¡å¸³æœ¬</label>
          <select id="categorySelect"></select>
        </div>
      </div>

      <div class="flex-row">
        <div class="field">
          <label for="amountInput">é‡‘é¡ï¼ˆæ­£æ•¸ï¼‰</label>
          <input type="number" id="amountInput" min="0" step="1" placeholder="ä¾‹å¦‚ 120">
        </div>
        <div class="field" style="flex:2;">
          <label for="noteInput">å‚™è¨»</label>
          <input type="text" id="noteInput" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€Uberã€è–ªæ°´ã€çé‡‘â€¦">
        </div>
      </div>

      <div class="section-title" style="margin-top:4px;">è‡ªè¨‚åˆ†é¡å¸³æœ¬</div>
      <div class="flex-row">
        <div class="field">
          <label for="newCategoryInput">æ–°å¢åˆ†é¡åç¨±</label>
          <input type="text" id="newCategoryInput" placeholder="ä¾‹å¦‚ï¼šæ—…éŠã€æŠ•è³‡å¸³ã€æ¾³é–€å°ˆç”¨å¸³æœ¬â€¦">
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="btn-secondary" id="addCategoryBtn">ï¼‹ æ–°å¢åˆ†é¡</button>
        </div>
      </div>
      <div class="small-text">æç¤ºï¼šåˆ†é¡æ¸…å–®æœƒå„²å­˜åœ¨ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸‹æ¬¡æ‰“é–‹é‚„æœƒåœ¨ã€‚</div>

      <div class="btn-group">
        <button class="btn-primary" id="addRecordBtn">ï¼‹ æ–°å¢ç´€éŒ„</button>
      </div>
    </section>

    <hr>

    <!-- å…¨éƒ¨ç´€éŒ„ç¸½è¨ˆ -->
    <div class="section-title">å…¨éƒ¨ç´€éŒ„ç¸½è¨ˆ</div>
    <div class="summary-card">
      <div class="summary-item">
        <div class="summary-label">ç¸½æ”¶å…¥</div>
        <div class="summary-value summary-income" id="totalIncome">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">ç¸½æ”¯å‡º</div>
        <div class="summary-value summary-expense" id="totalExpense">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">ç¸½çµé¤˜ï¼ˆæ”¶å…¥ï¼æ”¯å‡ºï¼‰</div>
        <div class="summary-value summary-balance" id="totalBalance">0</div>
      </div>
    </div>

    <!-- å€é–“ + åˆ†é¡ç¸½è¨ˆ -->
    <div class="section-title">å€é–“ & åˆ†é¡ç¸½è¨ˆ</div>
    <section>
      <div class="filter-row">
        <div class="field">
          <label for="rangeType">æ™‚é–“ç¯„åœ</label>
          <select id="rangeType">
            <option value="all">å…¨éƒ¨ç´€éŒ„</option>
            <option value="year">ä»Šå¹´</option>
            <option value="month">æœ¬æœˆ</option>
            <option value="day">ä»Šå¤©</option>
            <option value="custom">è‡ªè¨‚å€é–“</option>
          </select>
        </div>
        <div class="field" id="customRangeGroup" style="display:none;">
          <label>è‡ªè¨‚æ—¥æœŸå€é–“</label>
          <div class="flex-row" style="gap:4px; margin-bottom:0;">
            <input type="date" id="rangeStart">
            <span style="align-self:center; font-size:0.8rem;">ï½</span>
            <input type="date" id="rangeEnd">
          </div>
        </div>
        <div class="field" style="align-self:flex-end; min-width:auto;">
          <button class="btn-secondary" id="applyRangeBtn">å¥—ç”¨ç¯©é¸</button>
        </div>
      </div>
      <div class="hint-text">èªªæ˜ï¼šé¸æ“‡æƒ³æŸ¥çœ‹çš„æœŸé–“ï¼Œä¸‹é¢æœƒé¡¯ç¤ºè©²æœŸé–“å„åˆ†é¡çš„æ”¶å…¥ã€æ”¯å‡ºèˆ‡çµé¤˜ã€‚</div>

      <!-- å€é–“ç¸½è¨ˆå°å¡ -->
      <div class="summary-card" id="rangeSummaryCard">
        <div class="summary-item">
          <div class="summary-label">æ­¤å€é–“æ”¶å…¥</div>
          <div class="summary-value summary-income" id="rangeIncome">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æ­¤å€é–“æ”¯å‡º</div>
          <div class="summary-value summary-expense" id="rangeExpense">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æ­¤å€é–“çµé¤˜</div>
          <div class="summary-value summary-balance" id="rangeBalance">0</div>
        </div>
      </div>

      <!-- å€é–“å…§å„åˆ†é¡çµ±è¨ˆ -->
      <table>
        <thead>
          <tr>
            <th>åˆ†é¡å¸³æœ¬</th>
            <th>æ”¶å…¥</th>
            <th>æ”¯å‡º</th>
            <th>çµé¤˜</th>
          </tr>
        </thead>
        <tbody id="categorySummaryTbody">
          <!-- å‹•æ…‹å¡«å…¥ -->
        </tbody>
      </table>
      <div id="categorySummaryHint" class="no-data" style="display:none;">æ­¤å€é–“å…§ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</div>
    </section>

    <hr>

    <!-- ç´€éŒ„åˆ—è¡¨ -->
    <div class="records-header">
      <div class="records-header-title">ç´€éŒ„åˆ—è¡¨ï¼ˆå…¨éƒ¨ï¼‰</div>
      <button class="btn-danger" id="clearAllBtn">æ¸…ç©ºå…¨éƒ¨ç´€éŒ„</button>
    </div>

    <section>
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸæ™‚é–“</th>
            <th>é¡å‹</th>
            <th>åˆ†é¡å¸³æœ¬</th>
            <th>é‡‘é¡</th>
            <th>å‚™è¨»</th>
            <th>åˆªé™¤</th>
          </tr>
        </thead>
        <tbody id="recordsTbody">
          <!-- å‹•æ…‹å¡«å…¥ -->
        </tbody>
      </table>
      <div id="noDataHint" class="no-data" style="display:none;">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ï¼Œå¯ä»¥å…ˆå¾ä¸Šé¢æ–°å¢ä¸€ç­† âœï¸</div>
    </section>

    <div class="small-text" style="text-align:right; margin-top:8px;">
      è³‡æ–™åƒ…å„²å­˜åœ¨æ­¤è£ç½®çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚
    </div>
  </div>

  <script>
    // === LocalStorage Keys ===
    const STORAGE_KEY_RECORDS = "ledger_records_v1";
    const STORAGE_KEY_CATEGORIES = "ledger_categories_v1";

    // === Elements ===
    const datetimeInput = document.getElementById("datetimeInput");
    const nowBtn = document.getElementById("nowBtn");
    const typeInput = document.getElementById("typeInput");
    const categorySelect = document.getElementById("categorySelect");
    const amountInput = document.getElementById("amountInput");
    const noteInput = document.getElementById("noteInput");
    const newCategoryInput = document.getElementById("newCategoryInput");
    const addCategoryBtn = document.getElementById("addCategoryBtn");
    const addRecordBtn = document.getElementById("addRecordBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const recordsTbody = document.getElementById("recordsTbody");
    const noDataHint = document.getElementById("noDataHint");

    // å…¨éƒ¨ç´€éŒ„ç¸½è¨ˆæ¬„ä½
    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpenseEl = document.getElementById("totalExpense");
    const totalBalanceEl = document.getElementById("totalBalance");

    // å€é–“ç¯©é¸ç›¸é—œ
    const rangeTypeSelect = document.getElementById("rangeType");
    const customRangeGroup = document.getElementById("customRangeGroup");
    const rangeStartInput = document.getElementById("rangeStart");
    const rangeEndInput = document.getElementById("rangeEnd");
    const applyRangeBtn = document.getElementById("applyRangeBtn");

    const rangeIncomeEl = document.getElementById("rangeIncome");
    const rangeExpenseEl = document.getElementById("rangeExpense");
    const rangeBalanceEl = document.getElementById("rangeBalance");
    const categorySummaryTbody = document.getElementById("categorySummaryTbody");
    const categorySummaryHint = document.getElementById("categorySummaryHint");

    // === State ===
    let records = [];
    let categories = [];

    // å–å¾—ç¾åœ¨æ™‚é–“ä¸¦æ ¼å¼åŒ–æˆ datetime-local
    function getNowForInput() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const day = String(now.getDate()).padStart(2, "0");
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function setNowToInput() {
      datetimeInput.value = getNowForInput();
    }

    // è®€å– LocalStorage
    function loadFromStorage() {
      const recStr = localStorage.getItem(STORAGE_KEY_RECORDS);
      const catStr = localStorage.getItem(STORAGE_KEY_CATEGORIES);

      records = recStr ? JSON.parse(recStr) : [];
      categories = catStr ? JSON.parse(catStr) : [];
      if (!Array.isArray(categories) || categories.length === 0) {
        categories = ["ä¸€èˆ¬", "é£²é£Ÿ", "äº¤é€š", "ç”Ÿæ´»", "å¨›æ¨‚", "æŠ•è³‡", "é†«ç™‚", "å…¶ä»–"];
      }
    }

    // å„²å­˜åˆ° LocalStorage
    function saveRecords() {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
    }
    function saveCategories() {
      localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(categories));
    }

    // æ›´æ–°åˆ†é¡ä¸‹æ‹‰é¸å–®
    function renderCategoryOptions() {
      categorySelect.innerHTML = "";
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    // è¨ˆç®—ä¸¦æ›´æ–°ã€Œå…¨éƒ¨ç´€éŒ„ã€ç¸½è¨ˆ
    function updateTotals() {
      let income = 0;
      let expense = 0;
      records.forEach(r => {
        if (r.type === "income") {
          income += r.amount;
        } else if (r.type === "expense") {
          expense += r.amount;
        }
      });
      const balance = income - expense;

      totalIncomeEl.textContent = income.toLocaleString();
      totalExpenseEl.textContent = expense.toLocaleString();
      totalBalanceEl.textContent = balance.toLocaleString();
    }

    // é¡¯ç¤ºç”¨æ™‚é–“æ ¼å¼
    function formatDatetimeDisplay(dtStr) {
      if (!dtStr) return "";
      // dtStr é æœŸæ ¼å¼ï¼šYYYY-MM-DDTHH:mm
      const [datePart, timePart] = dtStr.split("T");
      if (!datePart || !timePart) return dtStr;
      const [y, m, d] = datePart.split("-");
      const [hh, mm] = timePart.split(":");
      return `${y}/${m}/${d} ${hh}:${mm}`;
    }

    // æ¸²æŸ“ç´€éŒ„è¡¨æ ¼ï¼ˆå…¨éƒ¨ï¼‰
    function renderRecords() {
      recordsTbody.innerHTML = "";
      if (records.length === 0) {
        noDataHint.style.display = "block";
        updateTotals(); // å…¨éƒ¨æ¸…ç©ºæ™‚ç¸½è¨ˆä¹Ÿæ­¸é›¶
        // å€é–“åˆ†é¡ä¹Ÿè¦æ¸…ç©º
        updateRangeSummary();
        return;
      } else {
        noDataHint.style.display = "none";
      }

      // ä¾æ™‚é–“æ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
      const sorted = [...records].sort((a, b) => {
        if (a.datetime === b.datetime) return 0;
        return a.datetime < b.datetime ? 1 : -1;
      });

      sorted.forEach(rec => {
        const tr = document.createElement("tr");

        const tdTime = document.createElement("td");
        tdTime.textContent = formatDatetimeDisplay(rec.datetime);
        tr.appendChild(tdTime);

        const tdType = document.createElement("td");
        tdType.textContent = rec.type === "income" ? "æ”¶å…¥" : "æ”¯å‡º";
        tdType.className = rec.type === "income" ? "type-income" : "type-expense";
        tr.appendChild(tdType);

        const tdCat = document.createElement("td");
        tdCat.textContent = rec.category || "";
        tr.appendChild(tdCat);

        const tdAmount = document.createElement("td");
        tdAmount.textContent = rec.amount.toLocaleString();
        tr.appendChild(tdAmount);

        const tdNote = document.createElement("td");
        tdNote.textContent = rec.note || "";
        tdNote.className = "note-cell";
        tr.appendChild(tdNote);

        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆªé™¤";
        delBtn.className = "btn-danger";
        delBtn.style.padding = "4px 10px";
        delBtn.style.fontSize = "0.75rem";
        delBtn.addEventListener("click", () => {
          if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
            records = records.filter(r => r.id !== rec.id);
            saveRecords();
            renderRecords();
          }
        });
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        recordsTbody.appendChild(tr);
      });

      // æ¸²æŸ“å®Œåˆ—è¡¨å¾Œï¼Œæ›´æ–°ç¸½è¨ˆ + å€é–“çµ±è¨ˆ
      updateTotals();
      updateRangeSummary();
    }

    // å–å¾—ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹çš„ç´€éŒ„
    function getFilteredRecordsByRange() {
      const type = rangeTypeSelect.value;
      if (records.length === 0) return [];

      const now = new Date();
      const nowYear = now.getFullYear();
      const nowMonth = now.getMonth(); // 0-11
      const nowDate = now.getDate();

      return records.filter(rec => {
        if (!rec.datetime) return false;
        const recDate = new Date(rec.datetime);

        if (type === "all") {
          return true;
        } else if (type === "year") {
          return recDate.getFullYear() === nowYear;
        } else if (type === "month") {
          return recDate.getFullYear() === nowYear &&
                 recDate.getMonth() === nowMonth;
        } else if (type === "day") {
          return recDate.getFullYear() === nowYear &&
                 recDate.getMonth() === nowMonth &&
                 recDate.getDate() === nowDate;
        } else if (type === "custom") {
          const startStr = rangeStartInput.value;
          const endStr = rangeEndInput.value;
          if (!startStr || !endStr) return false;
          const start = new Date(startStr + "T00:00:00");
          const end = new Date(endStr + "T23:59:59");
          if (isNaN(start.getTime()) || isNaN(end.getTime())) return false;
          return recDate >= start && recDate <= end;
        }
        return true;
      });
    }

    // æ›´æ–°ã€Œå€é–“ & åˆ†é¡ç¸½è¨ˆã€
    function updateRangeSummary() {
      const filtered = getFilteredRecordsByRange();

      if (!filtered || filtered.length === 0) {
        rangeIncomeEl.textContent = "0";
        rangeExpenseEl.textContent = "0";
        rangeBalanceEl.textContent = "0";
        categorySummaryTbody.innerHTML = "";
        categorySummaryHint.style.display = "block";
        return;
      }

      categorySummaryHint.style.display = "none";

      // å€é–“ç¸½æ”¶å…¥/æ”¯å‡º
      let income = 0;
      let expense = 0;

      // å„åˆ†é¡å½™ç¸½ï¼š { [category]: { income, expense } }
      const map = {};

      filtered.forEach(rec => {
        const cat = rec.category || "æœªåˆ†é¡";
        if (!map[cat]) {
          map[cat] = { income: 0, expense: 0 };
        }
        if (rec.type === "income") {
          income += rec.amount;
          map[cat].income += rec.amount;
        } else if (rec.type === "expense") {
          expense += rec.amount;
          map[cat].expense += rec.amount;
        }
      });

      const balance = income - expense;
      rangeIncomeEl.textContent = income.toLocaleString();
      rangeExpenseEl.textContent = expense.toLocaleString();
      rangeBalanceEl.textContent = balance.toLocaleString();

      // æ¸²æŸ“åˆ†é¡è¡¨æ ¼
      categorySummaryTbody.innerHTML = "";

      const cats = Object.keys(map).sort();
      cats.forEach(cat => {
        const info = map[cat];
        const row = document.createElement("tr");

        const tdCat = document.createElement("td");
        tdCat.textContent = cat;
        row.appendChild(tdCat);

        const tdIn = document.createElement("td");
        tdIn.textContent = info.income.toLocaleString();
        row.appendChild(tdIn);

        const tdOut = document.createElement("td");
        tdOut.textContent = info.expense.toLocaleString();
        row.appendChild(tdOut);

        const tdBal = document.createElement("td");
        tdBal.textContent = (info.income - info.expense).toLocaleString();
        row.appendChild(tdBal);

        categorySummaryTbody.appendChild(row);
      });
    }

    // æ–°å¢åˆ†é¡
    function handleAddCategory() {
      const name = newCategoryInput.value.trim();
      if (!name) {
        alert("è«‹è¼¸å…¥åˆ†é¡åç¨±");
        return;
      }
      if (categories.includes(name)) {
        alert("æ­¤åˆ†é¡å·²å­˜åœ¨");
        return;
      }
      categories.push(name);
      saveCategories();
      renderCategoryOptions();
      categorySelect.value = name;
      newCategoryInput.value = "";
    }

    // æ–°å¢ç´€éŒ„
    function handleAddRecord() {
      const dt = datetimeInput.value;
      const type = typeInput.value;
      const category = categorySelect.value;
      const amountStr = amountInput.value;
      const note = noteInput.value.trim();

      if (!dt) {
        alert("è«‹é¸æ“‡æ—¥æœŸæ™‚é–“");
        return;
      }
      if (!amountStr || Number(amountStr) <= 0) {
        alert("è«‹è¼¸å…¥å¤§æ–¼ 0 çš„é‡‘é¡");
        return;
      }
      const amount = Number(amountStr);

      const record = {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        datetime: dt,
        type,
        category,
        amount,
        note,
        createdAt: new Date().toISOString()
      };

      records.push(record);
      saveRecords();
      renderRecords();

      // æ¸…ç©ºé‡‘é¡èˆ‡å‚™è¨»ï¼Œæ™‚é–“ä¿ç•™ï¼ˆæ–¹ä¾¿é€£çºŒè¨˜éŒ„åŒä¸€æ™‚é–“é™„è¿‘ï¼‰
      amountInput.value = "";
      noteInput.value = "";
    }

    // æ¸…ç©ºå…¨éƒ¨ç´€éŒ„
    function handleClearAll() {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
      records = [];
      saveRecords();
      renderRecords();
    }

    // è™•ç†æ™‚é–“ç¯„åœé¸æ“‡ï¼ˆé¡¯ç¤º/éš±è—è‡ªè¨‚æ—¥æœŸï¼‰
    function handleRangeTypeChange() {
      if (rangeTypeSelect.value === "custom") {
        customRangeGroup.style.display = "block";
      } else {
        customRangeGroup.style.display = "none";
      }
    }

    // å¥—ç”¨ç¯©é¸æŒ‰éˆ•
    function handleApplyRange() {
      if (rangeTypeSelect.value === "custom") {
        const s = rangeStartInput.value;
        const e = rangeEndInput.value;
        if (!s || !e) {
          alert("è«‹é¸æ“‡è‡ªè¨‚å€é–“çš„èµ·è¨–æ—¥æœŸ");
          return;
        }
      }
      updateRangeSummary();
    }

    // åˆå§‹åŒ–
    function init() {
      loadFromStorage();
      renderCategoryOptions();
      setNowToInput();
      renderRecords();      // å…§éƒ¨æœƒé †ä¾¿æ›´æ–°ç¸½è¨ˆèˆ‡å€é–“çµ±è¨ˆ
      updateTotals();
      updateRangeSummary();

      nowBtn.addEventListener("click", setNowToInput);
      addCategoryBtn.addEventListener("click", handleAddCategory);
      addRecordBtn.addEventListener("click", handleAddRecord);
      clearAllBtn.addEventListener("click", handleClearAll);

      rangeTypeSelect.addEventListener("change", () => {
        handleRangeTypeChange();
        // ä¸æ˜¯è‡ªè¨‚æ™‚ï¼Œç›´æ¥åˆ·æ–°å€é–“çµ±è¨ˆ
        if (rangeTypeSelect.value !== "custom") {
          updateRangeSummary();
        }
      });
      applyRangeBtn.addEventListener("click", handleApplyRange);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
